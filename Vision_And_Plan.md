# Project Phoenix: A Vision for a Hierarchical Document Factory

This document outlines the vision and technical plan to evolve the "Expert" application from a single-loop text refiner into a comprehensive, hierarchical document generation platform.

## 1. Core Vision & Guiding Principles

The goal is to create a "document factory" capable of producing complex, long-form documents (e.g., novels, technical manuals, screenplays) by orchestrating LLM interactions at various levels of a user-defined hierarchy. The ultimate ambition is to enable the generation of a complete, structured document from a single, high-level user idea.

- **Principle 1: Modularity.** The core generation engine (`LoopOrchestrator`) should remain decoupled. The new system will be built as a managing layer on top of it, not by modifying it.
- **Principle 2: User-Definability.** The user, not the application, should define the structure. Hierarchies (Book -> Act -> Chapter) and Scaffolding (Outline, Character Bios) must be customizable templates.
- **Principle 3: Stateful Consistency.** The system must actively work to maintain consistency across the entire document, using mechanisms like automated summarization to provide relevant context for new generation tasks.
- **Principle 4: Automated Scaffolding.** The system should be able to generate its own foundational scaffolding (outlines, character bios, etc.) from a simple user prompt, bootstrapping the entire creative process.

## 2. Key Concepts & Data Models

We will introduce a set of new, core concepts to manage the complexity.

### a. `Project`
The top-level container for an entire document. It holds the project's name, its chosen `HierarchyTemplate`, and the root `DocumentNode`.

### b. `HierarchyTemplate`
A user-definable template that specifies the layers of a project.
- **Example for a Novel:**
  - Level 0: Book
  - Level 1: Act
  - Level 2: Chapter
- **Example for a Technical Manual:**
  - Level 0: Manual
  - Level 1: Section
  - Level 2: Topic
  - Level 3: Sub-Topic

### c. `DocumentNode`
The fundamental unit of the project, representing a single piece of the hierarchy (e.g., a specific Chapter, a summary of an Act). Each node is part of a tree structure.
```typescript
interface DocumentNode {
    id: string;
    level: number; // e.g., 2 for "Chapter"
    title: string;
    
    // The primary text content of this node
    content: string; 

    // An LLM-generated summary of its own content, used for parent context
    summary: string; 

    // Context inherited from parent and scaffolding to guide generation
    inheritedContext: string; 
    
    // The specific quality criteria used to generate/refine this node's content
    criteria: QualityCriterion[];
    
    // Link to parent and children
    parentId: string | null;
    children: DocumentNode[];
}
```

### d. `Scaffolding`
User-provided, project-wide documents that provide global context, such as a master outline, character sheets, world-building guides, or style guides. **Crucially, these documents can also be generated by the system itself.**

### e. `GenerationJob`
A specific task for the `LoopOrchestrator` to execute. This is a flexible concept that includes:
- **Content Generation:** "Generate content for Chapter 5."
- **Summarization:** "Summarize Act 1."
- **Scaffolding Generation:** "Create a detailed plot outline based on this one-sentence idea." or "Generate three main character descriptions for a fantasy novel."

## 3. Proposed Architecture & Implementation Plan

This will be a phased implementation, building from the core data models up to the UI.

### Phase 0: Automated Project Bootstrapping

**Goal:** Allow a user to initiate a new project from a single idea, automatically generating the initial scaffolding.
**Logic:**
1.  The user provides a high-level prompt (e.g., "A sci-fi detective story on Mars").
2.  The user selects a **`ProjectTemplate`** (e.g., "Novel," "Technical Manual"). This is a configuration file (e.g., a JSON file) that specifies:
    - A list of scaffolding documents to be created (e.g., `["Plot Outline", "Character Sheets", "World Anvil"]`).
    - The `HierarchyTemplate` to use for the main content (e.g., `["Book", "Act", "Chapter"]`).
3.  The `ProjectManager` reads the selected template and creates a series of `GenerationJob`s, one for each required scaffolding document.
4.  Crucially, the system can leverage different **saved settings profiles** for this phase. For example, a "Brainstorming" profile with a highly creative model and loose criteria can be used to generate the outline, which is different from the "Prose" profile used for writing chapters.
**Outcome:** A user can start with a single sentence and a selected template, and end up with a fully structured, albeit empty, project with rich, AI-generated outlines and reference material, ready for content generation. This architecture also allows for the future possibility of LLMs generating new `ProjectTemplate` files themselves.

### Phase 1: The Core Data Model

**Goal:** Create the foundational classes for managing a project's structure in memory.
**New Files:**
- **`src/ProjectManager.ts`**: A new master class to manage the entire project state. It will hold the `DocumentNode` tree, the templates, and the scaffolding. It will be the primary interface for the UI.
- **`src/DocumentNode.ts`**: The class definition for a `DocumentNode`.
- **`src/HierarchyTemplate.ts`**: The class for defining and managing hierarchy templates.

**Outcome:** The ability to create, modify, and store a project's structure programmatically. No UI changes yet.

### Phase 2: The Generation Engine Integration

**Goal:** Enable the `ProjectManager` to use the existing `LoopOrchestrator` to generate content for a *single* `DocumentNode`.
**Logic:**
1. The `ProjectManager` will have a method like `generateNodeContent(nodeId: string)`.
2. This method compiles a master prompt containing the `inheritedContext` and any specific instructions for that node.
3. It creates a `GenerationJob` and passes it to the `LoopOrchestrator`.
4. Since the orchestrator is event-driven, `ProjectManager` listens for the `progress` events and updates the `DocumentNode`'s content in real-time.

**Outcome:** We can programmatically tell the system to write Chapter 3, and it will use the `LoopOrchestrator` to do so.

### Phase 3: Hierarchical Generation & Summarization

**Goal:** Implement the "secret sauce" of the document factory.
**Logic:**
1.  **Context Inheritance:** When a `GenerationJob` for a node is created, the `ProjectManager` will gather context. This includes:
    - Relevant `Scaffolding` (e.g., the master outline).
    - The `summary` of the parent node.
    - The `summaries` of sibling nodes (e.g., the summary of Chapter 2 when writing Chapter 3).
2.  **Automated Summarization:** After a node's content is successfully generated, a new `GenerationJob` is automatically queued to create its `summary`. This summary is then stored in the node, ready to be used as context for other parts of the project.

**Outcome:** A fully automated, consistency-aware generation pipeline. We can kick off a job for an "Act," and the system will proceed to generate each "Chapter" within it sequentially, using the output of the previous steps to inform the next.

### Phase 4: The UI Overhaul

**Goal:** Build a user interface that can manage the new project structure.
**Components:**
1.  **Project Tree View:** A collapsible sidebar showing the hierarchical structure of the document (like a file explorer in a code editor). This will be the primary navigation.
2.  **Node Editor:** The main content area will be a rich text editor for viewing and editing the `content` of the selected `DocumentNode`.
3.  **Context/Scaffolding Panel:** A panel to view and edit the scaffolding documents and the `inheritedContext` for the selected node.
4.  **Template Editor:** A new settings area to create and edit `HierarchyTemplate`s.

### Phase 5: Advanced Features & Future Work

- **Parallel Generation:** Run generation jobs for non-dependent nodes (e.g., two different chapters in Act 2) in parallel.
- **Exporting:** A robust export system to compile the entire document tree into formats like `.md`, `.docx`, or `.epub`.
- **Interactive Scaffolding:** Allow LLM collaboration on creating the initial scaffolding and outlines.

## 4. Impact on Existing Code

- **`LoopOrchestrator.ts` & `EventEmitter.ts`**: **No changes needed.** This is the primary benefit of our recent decoupling. They will serve as the low-level engine.
- **`main.ts`**: Will be heavily refactored. It will no longer manage state directly. Instead, it will instantiate the `ProjectManager` and serve as the "View" layer, rendering the UI based on the `ProjectManager`'s state and calling its methods based on user interaction.
- **`SettingsManager.ts` & `PromptManager.ts`**: Their responsibilities will likely be absorbed into the new, more comprehensive `ProjectManager`.

This plan provides a clear, iterative path from our current application to the powerful document factory you envision. 